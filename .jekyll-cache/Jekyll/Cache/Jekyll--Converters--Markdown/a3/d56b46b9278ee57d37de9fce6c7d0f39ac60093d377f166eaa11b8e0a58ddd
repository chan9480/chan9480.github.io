I"Âu<p class="notice--warning">ì¸í”„ëŸ°ì— ìˆëŠ” í™ì •ëª¨ êµìˆ˜ë‹˜ì˜ <strong>í™ì •ëª¨ì˜ ë”°ë¼ í•˜ë©° ë°°ìš°ëŠ” C++</strong> ê°•ì˜ë¥¼ ë“£ê³  ì •ë¦¬í•œ í•„ê¸°ì…ë‹ˆë‹¤. ğŸ˜€  <br />
<a href="https://www.inflearn.com/course/following-c-plus">ğŸŒœ [í™ì •ëª¨ì˜ ë”°ë¼ í•˜ë©° ë°°ìš°ëŠ” C++]ê°•ì˜ ë“¤ìœ¼ëŸ¬ ê°€ê¸°!</a></p>

<p><br /></p>

<h1 id="chapter-19-ëª¨ë˜-c-í•„ìˆ˜-ìš”ì†Œë“¤">chapter 19. ëª¨ë˜ C++ í•„ìˆ˜ ìš”ì†Œë“¤</h1>

<h1 id="ë ˆì´ìŠ¤-ì»¨ë””ì…˜-stdatomic-stdscoped_lock">ë ˆì´ìŠ¤ ì»¨ë””ì…˜, std::atomic, std::scoped_lock</h1>

<h2 id="-ë ˆì´ìŠ¤-ì»¨ë””ì…˜race-conditionì´ë€">ğŸ”” ë ˆì´ìŠ¤ ì»¨ë””ì…˜(Race Condition)ì´ë€</h2>

<blockquote>
  <p><strong>Race Condition</strong> ğŸ‘‰ ë™ì¼í•œ ë°ì´í„°ë¥¼ ì„œë¡œ ë‹¤ë¥¸ ì—¬ëŸ¬ ìŠ¤ë ˆë“œë“¤ì´ ì ‘ê·¼í•˜ëŠ” ê³¼ì •ì—ì„œ ìƒê¸°ëŠ” ë¬¸ì œ</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ë©€í‹° ìŠ¤ë ˆë”©</code>ì€ ì—¬ëŸ¬ê°œì˜ ìŠ¤ë ˆë“œë“¤ì´ í•˜ë‚˜ì˜ ë©”ëª¨ë¦¬ë¥¼ ê³µìœ í•˜ê¸° ë•Œë¬¸ì— ì˜¤ë¥˜ê°€ ë°œìƒí™œ í™•ë¥ ì´ ë†’ë‹¤. ğŸ‘‰ <code class="language-plaintext highlighter-rouge">ë ˆì´ìŠ¤ ì»¨ë””ì…˜</code>
    <ul>
      <li>ì ‘ê·¼ í•˜ëŠ” ìˆœì„œì— ë”°ë¼ ë°ì´í„° ë˜ëŠ” ê²°ê³¼ê°’ì´ ìˆ˜ì •ë˜ê³  ê·¸ ìˆ˜ì •ëœ ë°ì´í„°ì— ë‹¤ë¥¸ ë°ì´í„°ê°€ ì ‘ê·¼í•˜ë ¤ ì˜ëª»ëœ ê²°ê³¼ê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.</li>
    </ul>
  </li>
</ul>

<h3 id="ë ˆì´ìŠ¤-ì»¨ë””ì…˜ì´-ë°œìƒí•˜ëŠ”-ê³¼ì •">ë ˆì´ìŠ¤ ì»¨ë””ì…˜ì´ ë°œìƒí•˜ëŠ” ê³¼ì •</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
#include &lt;mutex&gt;
#include &lt;atomic&gt;
#include &lt;thread&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shared_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">auto</span> <span class="n">count_func</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">](){</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">shared_memory</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="kr">thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>
	<span class="kr">thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>

	<span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
	<span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
	
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"After"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">shared_memory</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ğŸ’ì¶œë ¥ğŸ’

After
1962
</code></pre></div></div>

<blockquote>
  <p>0 ì´ˆê¸° ê°’ì„ ê°€ì§„ <code class="language-plaintext highlighter-rouge">shared_memory</code>ë¼ëŠ” ë³€ìˆ˜ì— ì—´ ìŠ¤ë ˆë“œë“¤ì´ ë™ì‹œì— ì ‘ê·¼í•˜ë„ë¡ í•´ë³¼ ê²ƒì´ë‹¤.</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">count_func</code>ëŠ” 1 ë°€ë¦¬ì„¸ì»¨ì¦ˆ ëŒ€ê¸°í•˜ê³ ë‚œ í›„ <code class="language-plaintext highlighter-rouge">shared_memory</code>ë¥¼ 1ë§Œí¼ ì¦ê°€ì‹œí‚¤ëŠ” ì¼ì„ í•˜ëŠ” í•¨ìˆ˜ë‹¤.
    <ul>
      <li>ëª¨ë“  ì™¸ë¶€ ë³€ìˆ˜ë¥¼ ë ˆí¼ëŸ°ìŠ¤ë¡œ ë°›ëŠ” <code class="language-plaintext highlighter-rouge">[&amp;]</code> ëŒë‹¤ í•¨ìˆ˜ì´ë¯€ë¡œ <code class="language-plaintext highlighter-rouge">shared_memory</code> ê°’ë„ ë³€í•˜ê²Œ ëœë‹¤.</li>
      <li><code class="language-plaintext highlighter-rouge">sleep_for</code> í•¨ìˆ˜ë¥¼ ë‘ì–´ ëŒ€ê¸° ì‹œê°„ì„ ê°€ì§„ ì´ìœ ëŠ” ëŒ€ê¸° ì‹œê°„ ì—†ìœ¼ë©´  <code class="language-plaintext highlighter-rouge">shared_memory++;</code> ì—°ì‚°ì´ ë„ˆë¬´ ë‹¨ë°•ì— ë¹¨ë¦¬ ëë‚˜ë²„ë ¤ì„œ ë¬¸ì œê°€ ì•ˆë³´ì¼ ìˆ˜ ìˆì–´ì„œ</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">t1</code>, <code class="language-plaintext highlighter-rouge">t2</code> ìŠ¤ë ˆë“œëŠ” ê°ì <code class="language-plaintext highlighter-rouge">count_func</code> ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.</li>
</ul>

<blockquote>
  <p>ğŸ“¢ ë ˆì´ìŠ¤ ì»¨ë””ì…˜ ë°œìƒ !</p>
</blockquote>

<p>ê²°ê³¼ì ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">shared_memory</code> ê°’ì€ ìµœì¢…ì ìœ¼ë¡œ 2000 ì´ ë  ê²ƒìœ¼ë¡œ ê¸°ëŒ€ê°€ ë˜ì§€ë§Œ ì‹¤ì œë¡  1962 ê°€ ë‚˜ì™”ë‹¤! ë‹¤ì‹œ ì‹¤í–‰í•´ë³´ë©´ 1968ì´ ë‚˜ì˜¤ëŠ” ë“± ì‹¤í–‰ ë•Œë§ˆë‹¤ 2000 ê³¼ëŠ” ë‹¤ë¥¸ ê°’ì´ ë‚˜ì˜¤ê²Œ ëœë‹¤.</p>

<blockquote>
  <p>OS ëŠ” CPUê°€ ì–´ë–¤ ìŠ¤ë ˆë“œë¥¼ ì‹¤í–‰í• ì§€ì— ëŒ€í•œ <u>ìŠ¤ì¼€ì¤„ë§ì„ ë§ˆìŒ ëŒ€ë¡œ ê²°ì •í•œë‹¤.</u></p>
</blockquote>

<ul>
  <li>A ìŠ¤ë ˆë“œë¥¼ ì‘ì—…í•˜ëŠ” ì¤‘ê°„ì—ë„ B ìŠ¤ë ˆë“œë¥¼ ì‘ì—…í•˜ëŸ¬ ê°€ê³  ê·¸ëŸ´ ìˆ˜ ìˆìŒ</li>
  <li>ê·¸ë˜ì•¼ ë³‘ë ¬ì ìœ¼ë¡œ ì²˜ë¦¬ ë˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ë‹ˆê¹Œ!</li>
</ul>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">shared_memory++;</code> ì—°ì‚°ì‹œ ë‹¤ìŒê³¼ ê°™ì€ 3 ë‹¨ê³„ë¡œ ì§„í–‰ì´ ëœë‹¤.</p>
</blockquote>

<p><img src="https://user-images.githubusercontent.com/42318591/92492392-421f8200-f22e-11ea-820e-4388e63a3479.png" alt="image" width="90%" height="90%" class="align-center" /></p>

<ul>
  <li>1 ë‹¨ê³„ ğŸ‘‰ ë©”ëª¨ë¦¬ì— ìˆëŠ” <code class="language-plaintext highlighter-rouge">shared_memory </code>ê°’ì„ CPUë¡œ ë³´ë‚¸ë‹¤. CPUê°€ ë°ì´í„°ë¥¼ ì½ì–´ë“¤ì„!</li>
  <li>2 ë‹¨ê³„ ğŸ‘‰ CPU ì•ˆì—ì„œ ê°’ì„ +1 ë”í•˜ëŠ” ì—°ì‚°ì„ í•œë‹¤</li>
  <li>3 ë‹¨ê³„ ğŸ‘‰ ë”í•œ ê²°ê³¼ê°’ì„ ë‹¤ì‹œ <code class="language-plaintext highlighter-rouge">shared_memory</code>ì— ë®ì–´ì”Œìš´ë‹¤</li>
</ul>

<p><img src="https://user-images.githubusercontent.com/42318591/92492634-87dc4a80-f22e-11ea-802a-1b5355b369c1.png" alt="image" width="90%" height="90%" class="align-center" /></p>

<ol>
  <li>í˜„ì¬ <code class="language-plaintext highlighter-rouge">shared_memory</code> ê°’ì´ 624 ë¼ê³  ê°€ì •í•´ë³´ì.</li>
  <li><code class="language-plaintext highlighter-rouge">t1</code> ìŠ¤ë ˆë“œê°€ 1, 2 ë‹¨ê³„ë¥¼ ë§ˆì¹˜ê³  3ë‹¨ê³„ë¡œ ê°€ê¸° ì „ OS ëŠ” <em>sleep_for</em> ëŒ€ê¸° ì‹œê°„ì„ ëë‚¸ <code class="language-plaintext highlighter-rouge">t2</code> ìŠ¤ë ˆë“œì˜ ì‘ì—…ì„ ì²˜ë¦¬í•´ì¤€ë‹¤.
    <ul>
      <li>ì•„ì§ <code class="language-plaintext highlighter-rouge">t1</code>ì˜ ì—°ì‚° ê²°ê³¼ì¸ 625ë¥¼ <code class="language-plaintext highlighter-rouge">shared_memory</code>ì— ë®ì–´ì“°ì§€ ëª»í•œ ìƒíƒœì—ì„œ <code class="language-plaintext highlighter-rouge">t2</code>ë¡œ ë„˜ì–´ê°</li>
      <li>ì—¬ì „íˆ <code class="language-plaintext highlighter-rouge">shared_memory</code>ì˜ ê°’ì€ 624 ì¸ ìƒíƒœ.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">t2</code>ê°€ ì½ì‹¸ê²Œ 1, 2, 3 ë‹¨ê³„ë¥¼ ëª¨ë‘ ëëƒˆë‹¤ê³  ê°€ì •í•´ë³´ì.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">shared_memory</code>ì€ <code class="language-plaintext highlighter-rouge">t1</code> ìŠ¤ë ˆë“œê°€ 625ë¥¼ ë®ì–´ ì”Œìš°ì§€ ëª»í–ˆì–´ì„œ ì—¬ì „íˆ 624 ì´ë¯€ë¡œ ì´ ê°’ìœ¼ë¡œ 1, 2, 3 ë‹¨ê³„ë¥¼ ì§„í–‰í•˜ì—¬ <code class="language-plaintext highlighter-rouge">shared_memory</code>ëŠ” 625ê°€ ë˜ì—ˆë‹¤.</li>
    </ul>
  </li>
  <li>ë‹¤ì‹œ ëª»ë‹¤í•œ <code class="language-plaintext highlighter-rouge">t1</code> ìŠ¤ë ˆë“œì˜ 3 ë‹¨ê³„ ì‘ì—…ìœ¼ë¡œ ëŒì•„ì™”ë‹¤.
    <ul>
      <li><u>ìŠ¤ë ˆë“œë“¤ì€ ê°™ì€ ë©”ëª¨ë¦¬ë¥¼ ê³µìœ í•˜ì§€ë§Œ ê°ì ì‚¬ìš©í•˜ëŠ” CPUë‚´ì˜ ë ˆì§€ìŠ¤í„°ëŠ” ë³„ê°œì´ë‹¤.</u> ë”°ë¼ì„œ <code class="language-plaintext highlighter-rouge">t1</code> ìŠ¤ë ˆë“œì˜ ì—°ì‚° ê²°ê³¼ì˜€ë˜ 625ëŠ” CPU ë ˆì§€ìŠ¤í„° ë‚´ì— ë³´ê´€ë˜ì–´ ìˆëŠ” ìƒíƒœ.</li>
      <li>2 ë‹¨ê³„ì¸ CPU ì—°ì‚° ê²°ê³¼ì˜€ë˜ 625 ë¥¼ <code class="language-plaintext highlighter-rouge">shared_memory</code>ì— ë®ì–´ ì”Œìš´ë‹¤.</li>
      <li>ì´ë¯¸ <code class="language-plaintext highlighter-rouge">shared_memory</code>ëŠ” <code class="language-plaintext highlighter-rouge">t2</code> ìŠ¤ë ˆë“œì˜ ì‘ì—…ìœ¼ë¡œ 625 ê°€ ëœ ìƒíƒœì˜€ìœ¼ë¯€ë¡œ ê·¸ëŒ€ë¡œ 625 ë‹¤.</li>
    </ul>
  </li>
  <li>ë‘ ìŠ¤ë ˆë“œì˜ ì‘ì—…ìœ¼ë¡œ 624 ğŸ‘‰ 626 ì´ ë  ê²ƒìœ¼ë¡œ ê¸°ëŒ€í–ˆì§€ë§Œ ì •ì‘ 624 ğŸ‘‰ 625 ê°€ ëë‹¤.
    <ul>
      <li>ë§ì…ˆ ì—°ì‚° í•˜ë‚˜ê°€ ë¬´ì‹œëœ ê¼´! ê·¸ë˜ì„œ ìœ„ì—ì„œ 2000ì´ ë‚˜ì˜¤ì§€ ì•Šê³  1968 ê°™ì€ ë” ì ì€ ê°’ì´ ë‚˜ì˜¤ê²Œ ëœ ê²ƒì´ë‹¤.</li>
      <li>ì •ë¦¬í•˜ìë©´ <code class="language-plaintext highlighter-rouge">t1</code> ìŠ¤ë ˆë“œì˜ ì‘ì—… ë„ì¤‘ì— <code class="language-plaintext highlighter-rouge">t2</code> ìŠ¤ë ˆë“œê°€ ê°œì… ë˜ì—ˆê¸° ë•Œë¬¸ì— ì´ëŸ° ë¬¸ì œê°€ ë°œìƒí•œ ê²ƒì´ë‹¤.</li>
      <li><u>í•œ ìŠ¤ë ˆë“œê°€ ì‘ì—… í•˜ëŠ” ë„ì¤‘ì— ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ë™ì¼í•œ ë©”ëª¨ë¦¬ì— ì ‘ê·¼í–ˆê¸° ë•Œë¬¸</u></li>
    </ul>
  </li>
</ol>

<p><em>sleep_for</em> í•¨ìˆ˜ê°€ ì—†ë‹¤ë©´ 2000ìœ¼ë¡œ ê²°ê³¼ê°€ ì˜¬ë°”ë¥´ê²Œ ë‚˜ì˜¤ì§€ë§Œ ê·¸ë ‡ë‹¤ê³  í•´ì„œ ì˜¬ë°”ë¥´ê²Œ ë™ì‘í–ˆë‹¤ëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤. ë„ˆë¬´ ë„ˆë¬´ ë„ˆë¬´ ë¹ ë¥´ê²Œ forë¬¸ì„ 1000ë²ˆ ë‹¤ ëŒì•„ë²„ë ¤ì„œ <code class="language-plaintext highlighter-rouge">t2</code> ìŠ¤ë ˆë“œê°€ ê°œì…í•˜ê¸°ë„ ì „ì— <code class="language-plaintext highlighter-rouge">t1</code> ìŠ¤ë ˆë“œê°€ forë¬¸ 1000ë²ˆì„ ë‹¤ ëŒì•„ë²„ë¦¬ê¸° ë•Œë¬¸ì— ê·¸ëŸ° ê²ƒì´ë‹¤! ë”°ë¼ì„œ ì´ëŸ° ë ˆì´ìŠ¤ ì»¨ë””ì…˜ ë¬¸ì œë¥¼ ê´€ì¸¡í•˜ê¸° ìœ„í•´ ì ê¹ ì ê¹ì”© ëŒ€ê¸° ì‹œê°„ì„ ë‘ì—ˆë‹¤.</p>

<p><br /></p>

<h2 id="-ë ˆì´ìŠ¤-ì»¨ë””ì…˜-í•´ê²°-ë°©ë²•">ğŸ”” ë ˆì´ìŠ¤ ì»¨ë””ì…˜ í•´ê²° ë°©ë²•</h2>

<h3 id="stdatomic">std::atomic</h3>

<blockquote>
  <p>#include &lt;atomic&gt;</p>
</blockquote>

<ul>
  <li><u>ì•„ë˜ 3ë‹¨ê³„ë¥¼ ê¼­ í•œë²ˆì— ë‹¤ ì‹¤í–‰ë˜ê²Œë” ë¬¶ì–´ì¤€ë‹¤.</u> ìª¼ê°œì§ˆ ìˆ˜ ì—†ëŠ” ì›ìì²˜ëŸ¼!
    <ul>
      <li>1 ë‹¨ê³„ ğŸ‘‰ ë©”ëª¨ë¦¬ì— ìˆëŠ” <code class="language-plaintext highlighter-rouge">shared_memory </code>ê°’ì„ CPUë¡œ ë³´ë‚¸ë‹¤. CPUê°€ ë°ì´í„°ë¥¼ ì½ì–´ë“¤ì„!</li>
      <li>2 ë‹¨ê³„ ğŸ‘‰ CPU ì•ˆì—ì„œ ê°’ì„ +1 ë”í•˜ëŠ” ì—°ì‚°ì„ í•œë‹¤</li>
      <li>3 ë‹¨ê³„ ğŸ‘‰ ë”í•œ ê²°ê³¼ê°’ì„ ë‹¤ì‹œ <code class="language-plaintext highlighter-rouge">shared_memory</code>ì— ë®ì–´ì”Œìš´ë‹¤</li>
    </ul>
  </li>
  <li>ì‚¬ìš© ë°©ë²•
    <ul>
      <li>ë©”ëª¨ë¦¬ê°€ ê³µìœ ë˜ëŠ” ë³€ìˆ˜ë¥¼ <code class="language-plaintext highlighter-rouge">atomic</code> íƒ€ì…ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ëœë‹¤.
        <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">shared_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>        </div>
      </li>
      <li><code class="language-plaintext highlighter-rouge">atomic</code>ì— ì¦ê° ì—°ì‚°ì ê°™ì€ ì—¬ëŸ¬ ì—°ì‚°ìë“¤ì´ ì˜¤ë²„ë¡œë”© ë˜ì–´ìˆê¸° ë•Œë¬¸ì— <code class="language-plaintext highlighter-rouge">shared_memory++</code> í•  ìˆ˜ ìˆë‹¤.
        <ul>
          <li>í˜¹ì€ <code class="language-plaintext highlighter-rouge">shared_memory.fetch_add(1)</code></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ë‹¨ì 
    <ul>
      <li>ëŠë¦¬ë‹¤! <code class="language-plaintext highlighter-rouge">atomic</code>ì˜ ì—°ì‚°ì€ ë‹¹ì—° ì¼ë°˜ ì¦ê°ì—°ì‚°ë³´ë‹¤ ëŠë¦¬ë‹¤. ë‚¨ìš©í•˜ë©´ ì—„ì²­ ëŠë¦¬ë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
#include &lt;atomic&gt;
#include &lt;thread&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">shared_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	
	<span class="k">auto</span> <span class="n">count_func</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
			<span class="n">shared_memory</span><span class="o">++</span><span class="p">;</span>		<span class="c1">// í˜¹ì€ shared_memory.fetch_add(1);	</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>
	<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>

	<span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
	<span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"After"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">shared_memory</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ğŸ’ì¶œë ¥ğŸ’

After
2000
</code></pre></div></div>

<p><br /></p>

<h3 id="mutex-ì˜-lock-unlock">mutex ì˜ lock, unlock</h3>

<blockquote>
  <p>#include &lt;mutex&gt;</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">shared_memroy++</code>ì„ A ìŠ¤ë ˆë“œê°€ <u>ì´ë¯¸ ì‘ì—… ì¤‘ì´ê±°ë‚˜</u> <u>ì‘ì—…ì„ í•˜ë‹¤ê°€ ë§ì•˜ìœ¼ë©´</u> ë‹¤ë¥¸ ìŠ¤ë ˆë“œë“¤ì´ ëª» ê±´ë“œë¦¬ê²Œ ì ê¶ˆë‘”ë‹¤.
    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>

<span class="n">mtx</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
<span class="n">shared_memory</span><span class="o">++</span><span class="p">;</span>		
<span class="n">mtx</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
</code></pre></div>    </div>
  </li>
  <li>ë‹¨ì 
    <ul>
      <li><code class="language-plaintext highlighter-rouge">unlock</code>ì„ ë°˜ë“œì‹œ í•´ì¤˜ì•¼ ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ì‘ì—…ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ”ë° í”„ë¡œê·¸ë˜ë¨¸ê°€ ëª…ì‹œí•˜ëŠ” ê²ƒì„ ê¹œë¹¡í•  ìˆ˜ë„ ìˆë‹¤.</li>
      <li>ì˜ˆì™¸ê°€ ë°œìƒí•˜ê±°ë‚˜ í–ˆì„ë•Œ <code class="language-plaintext highlighter-rouge">unlock</code>ì„ ê±´ë„ˆë›¸ ìˆ˜ë„ ìˆë‹¤.</li>
    </ul>
  </li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
#include &lt;mutex&gt;
#include &lt;atomic&gt;
#include &lt;thread&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shared_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>

	<span class="k">auto</span> <span class="n">count_func</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">mtx</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
			<span class="n">shared_memory</span><span class="o">++</span><span class="p">;</span>		
			<span class="n">mtx</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>
	<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>

	<span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
	<span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"After"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">shared_memory</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ğŸ’ì¶œë ¥ğŸ’

After
2000
</code></pre></div></div>

<p><br /></p>

<h3 id="stdlock_guard">std::lock_guard</h3>

<blockquote>
  <p>#include &lt;mutex&gt;</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>

<span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>		<span class="c1">// unlockì„ í•´ì£¼ì§€ ì•Šì•„ë„ ìë™ìœ¼ë¡œ í•´ì¤Œ!</span>
<span class="n">shared_memory</span><span class="o">++</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">shared_memroy++</code>ì„ A ìŠ¤ë ˆë“œê°€ <u>ì´ë¯¸ ì‘ì—… ì¤‘ì´ê±°ë‚˜</u> <u>ì‘ì—…ì„ í•˜ë‹¤ê°€ ë§ì•˜ìœ¼ë©´</u> ë‹¤ë¥¸ ìŠ¤ë ˆë“œë“¤ì´ ëª» ê±´ë“œë¦¬ê²Œ ì ê¶ˆë‘”ë‹¤. mutexì˜ <code class="language-plaintext highlighter-rouge">lock í•¨ìˆ˜</code>, <code class="language-plaintext highlighter-rouge">unlock í•¨ìˆ˜</code>ì™€ ê¸°ëŠ¥ì€ ë™ì¼í•˜ë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">lock í•¨ìˆ˜</code>, <code class="language-plaintext highlighter-rouge">unlock í•¨ìˆ˜</code>ê³¼ ë‹¤ë¥¸ ì 
    <ul>
      <li>ğŸ‘‰ ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ì²˜ëŸ¼ ìì‹ ì˜ ì˜ì—­ì„ ë²—ì–´ë‚˜ë©´ <u>ìë™ìœ¼ë¡œ unlock()ì„ í˜¸ì¶œí•´ì¤€ë‹¤.</u>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">lock_guard</code> íƒ€ì…ì˜ ë³€ìˆ˜ <code class="language-plaintext highlighter-rouge">lock</code>ì€ forë¬¸ scopeë¥¼ ë²—ì–´ë‚˜ ë©”ëª¨ë¦¬ê°€ í•´ì œë  ë•Œ ìë™ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">unlock</code> ëœë‹¤.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
#include &lt;mutex&gt;
#include &lt;atomic&gt;
#include &lt;thread&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shared_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>
	<span class="k">auto</span> <span class="n">count_func</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>		<span class="c1">// unlockì„ í•´ì£¼ì§€ ì•Šì•„ë„ ìë™ìœ¼ë¡œ í•´ì¤Œ!</span>
			<span class="n">shared_memory</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>
	<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>

	<span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
	<span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"After"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">shared_memory</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ğŸ’ì¶œë ¥ğŸ’

After
2000
</code></pre></div></div>

<p><br /></p>

<h3 id="stdscoped_lock">std::scoped_lock</h3>

<blockquote>
  <p>#include &lt;mutex&gt;</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>

<span class="n">std</span><span class="o">::</span><span class="n">scoped_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>		<span class="c1">// unlockì„ í•´ì£¼ì§€ ì•Šì•„ë„ ìë™ìœ¼ë¡œ í•´ì¤Œ!</span>
<span class="n">shared_memory</span><span class="o">++</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">shared_memroy++</code>ì„ A ìŠ¤ë ˆë“œê°€ <u>ì´ë¯¸ ì‘ì—… ì¤‘ì´ê±°ë‚˜</u> <u>ì‘ì—…ì„ í•˜ë‹¤ê°€ ë§ì•˜ìœ¼ë©´</u> ë‹¤ë¥¸ ìŠ¤ë ˆë“œë“¤ì´ ëª» ê±´ë“œë¦¬ê²Œ ì ê¶ˆë‘”ë‹¤. mutexì˜ <code class="language-plaintext highlighter-rouge">lock í•¨ìˆ˜</code>, <code class="language-plaintext highlighter-rouge">unlock í•¨ìˆ˜</code>ì™€ ê¸°ëŠ¥ì€ ë™ì¼í•˜ë‹¤.</li>
  <li><code class="language-plaintext highlighter-rouge">std::lock_guard</code> í•¨ìˆ˜ì™€ ë™ì¼í•˜ë‹¤. ìŠ¤ë§ˆíŠ¸ í¬ì¸í„°ì²˜ëŸ¼ ìì‹ ì˜ ì˜ì—­ì„ ë²—ì–´ë‚˜ë©´ <u>ìë™ìœ¼ë¡œ unlock()ì„ í˜¸ì¶œí•´ì¤€ë‹¤.</u></li>
  <li>ë‹¨, C++ 17ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë©° <code class="language-plaintext highlighter-rouge">std::lock_guard</code> í•¨ìˆ˜ë³´ë‹¤ ê¶Œì¥ëœë‹¤.</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
#include &lt;mutex&gt;
#include &lt;atomic&gt;
#include &lt;thread&gt;
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">shared_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>
	<span class="k">auto</span> <span class="n">count_func</span> <span class="o">=</span> <span class="p">[</span><span class="o">&amp;</span><span class="p">]()</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">std</span><span class="o">::</span><span class="n">scoped_lock</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mtx</span><span class="p">);</span>		<span class="c1">// unlockì„ í•´ì£¼ì§€ ì•Šì•„ë„ ìë™ìœ¼ë¡œ í•´ì¤Œ!</span>
			<span class="n">shared_memory</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">};</span>

	<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>
	<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">count_func</span><span class="p">);</span>

	<span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
	<span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"After"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">shared_memory</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ğŸ’ì¶œë ¥ğŸ’

After
2000
</code></pre></div></div>

<hr />
<p><br /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ğŸŒœ ê°œì¸ ê³µë¶€ ê¸°ë¡ìš© ë¸”ë¡œê·¸ì…ë‹ˆë‹¤. ì˜¤ë¥˜ë‚˜ í‹€ë¦° ë¶€ë¶„ì´ ìˆì„ ê²½ìš° 
ì–¸ì œë“ ì§€ ëŒ“ê¸€ í˜¹ì€ ë©”ì¼ë¡œ ì§€ì í•´ì£¼ì‹œë©´ ê°ì‚¬í•˜ê² ìŠµë‹ˆë‹¤! ğŸ˜„
</code></pre></div></div>

<p><a href="#" class="btn btn--primary align-right">ë§¨ ìœ„ë¡œ ì´ë™í•˜ê¸°</a></p>
:ET